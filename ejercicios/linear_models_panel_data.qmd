---
title: "Clase N1"
author: "Samuel Suesca"
format:
  html:
      embed-resources: true
      code-fold: show
      code-tools: true
      code-block-bg: "#f1f3f5"
      code-block-border-left: "#31BAE9"
      code-overflow: wrap
      code-line-numbers: false
      code-copy: true
      highlight-style: github
      code-block-font-size: "0.8em"
editor: visual
  markdown: 
    wrap: 72
bibliography: reference.bib
---

$$Y_t = X_t$$

cita [@endres2019]

{r warnings = FALSE}

# Modelos de datos panel
```{r}
rm(list=ls(all=TRUE))
# Cargar paquetes necesarios
library(dplyr); library(haven); library(plm); library(tidyverse); library(summarytools); library(pder);
library(ggplot2);library(tidyr);library(panel)
```

```{r}


data("SeatBelt") 
head(SeatBelt)
attach(SeatBelt)

# Renombrar variables
data <- SeatBelt %>%
  rename(
    fatalities_occ = farsocc,
    fatalities_non_occ = farsnocc,
    belt_usage = usage,
    income = percapin,
    unemployment = unemp,
    age = meanage,
    pct_black = precentb,
    pct_hispanic = precenth,
    density_urban = densurb,
    density_rural = densrur,
    violent_crime = viopcap,
    property_crime = proppcap,
    vmt_rural = vmtrural,
    vmt_urban = vmturban,
    fuel_tax = fueltax,
    speed_65 = lim65,
    speed_70plus = lim70p,
    drinking_age_21 = mlda21,
    bac_limit_08 = bac08,
    belt_law_secondary = ds,
    belt_law_primary = dp,
    belt_law_primary_after_secondary = dsp
  )
```
```{r}

# Resumen estadístico de las variables numéricas
summary_stats <- data %>%
  select(where(is.numeric)) %>%
  summary()

print(summary_stats)

# Gráfico de evolución del uso del cinturón de seguridad por año
ggplot(data, aes(x = year, y = belt_usage, group = state)) +
  geom_line(alpha = 0.3) +
  geom_smooth(aes(group = 1), color = "red", se = FALSE) +
  labs(title = "Evolución del uso del cinturón de seguridad por estado (1983-1997)",
       x = "Año", y = "Tasa de uso del cinturón de seguridad") +
  theme_minimal()

# Relación entre el uso del cinturón de seguridad y las fatalidades
ggplot(data, aes(x = belt_usage, y = fatalities_occ)) +
  geom_point(alpha = 0.3) +
  geom_smooth(method = "lm", se = FALSE, color = "blue") +
  labs(title = "Relación entre el uso del cinturón de seguridad y las fatalidades de ocupantes",
       x = "Tasa de uso del cinturón de seguridad", y = "Número de fatalidades (ocupantes)") +
  theme_minimal()

# Relación entre el uso del cinturón de seguridad y las fatalidades
ggplot(data, aes(x = belt_usage, y = fatalities_non_occ)) +
  geom_point(alpha = 0.3) +
  geom_smooth(method = "lm", se = FALSE, color = "blue") +
  labs(title = "Relación entre el uso del cinturón de seguridad y las fatalidades de noocupantes",
       x = "Tasa de uso del cinturón de seguridad", y = "Número de fatalidades (no ocupantes)") +
  theme_minimal()

# Comparación de fatalidades antes y después de la implementación de leyes de cinturón de seguridad
data %>%
  mutate(belt_law = case_when(
    belt_law_secondary == 1 ~ "Secundaria",
    belt_law_primary == 1 ~ "Primaria",
    belt_law_primary_after_secondary == 1 ~ "Primaria después de secundaria",
    TRUE ~ "Sin ley"
  )) %>%
  group_by(belt_law) %>%
  summarise(avg_fatalities = mean(fatalities_occ, na.rm = TRUE)) %>%
  ggplot(aes(x = belt_law, y = avg_fatalities, fill = belt_law)) +
  geom_bar(stat = "identity") +
  labs(title = "Promedio de fatalidades por tipo de ley de cinturón de seguridad",
       x = "Tipo de ley", y = "Promedio de fatalidades (ocupantes)") +
  theme_minimal() +
  theme(legend.position = "none")


# Comparación de fatalidades antes y después de la implementación de leyes de cinturón de seguridad
data %>%
  mutate(belt_law = case_when(
    belt_law_secondary == 1 ~ "Secundaria",
    belt_law_primary == 1 ~ "Primaria",
    belt_law_primary_after_secondary == 1 ~ "Primaria después de secundaria",
    TRUE ~ "Sin ley"
  )) %>%
  group_by(belt_law) %>%
  summarise(avg_fatalities = mean(fatalities_non_occ, na.rm = TRUE)) %>%
  ggplot(aes(x = belt_law, y = avg_fatalities, fill = belt_law)) +
  geom_bar(stat = "identity") +
  labs(title = "Promedio de fatalidades por tipo de ley de cinturón de seguridad",
       x = "Tipo de ley", y = "Promedio de fatalidades (no ocupantes)") +
  theme_minimal() +
  theme(legend.position = "none")


# Mapa de calor de correlaciones entre variables numéricas
correlation_matrix <- data %>%
  select(where(is.numeric)) %>%
  cor(use = "pairwise.complete.obs")

ggplot(data = reshape2::melt(correlation_matrix)) +
  geom_tile(aes(x = Var1, y = Var2, fill = value)) +
  scale_fill_gradient2(low = "blue", high = "red", mid = "white", midpoint = 0) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(title = "Mapa de calor de correlaciones entre variables")
```

```{r}
length(unique(state))
length(unique(year))
pdim(data)$balanced
is.pbalanced(data) ## balanceado


# Dando estructura panel a la data
data <-  pdata.frame(data, c("state","year"))
attach(data)
```
```{r}
# Pool OLS
pool <- plm(fatalities_occ ~ age + belt_usage + violent_crime + unemployment + income +pct_black+pct_hispanic , data = data, model = "pooling", effect= "twoway")


summary(pool)
print(summary(pool), subset = c("age", "belt_usage", "violent_crime", "unemployment", "income", "pct_black", "pct_hispanic"))

```

```{r}
re <- plm(fatalities_occ ~ age + belt_usage + violent_crime + unemployment + income +pct_black+pct_hispanic , 
          data = data, model = "random")
print(summary(re), subset = c("age", "belt_usage", "violent_crime", "unemployment", "income", "pct_black", "pct_hispanic"))

# Unobserved effects test
# The unobserved effects test a la Wooldridge (see Wooldridge (2010) 10.4.4), is a semiparametric test for
# the null hypothesis that Var_unobservedeffects=0, i.e. that there are no unobserved effects in the residuals.
pwtest(fatalities_occ ~ age + belt_usage + violent_crime + unemployment + income +pct_black+pct_hispanic, data = data)

# Breusch-Pagan test: the LM test helps you decide between a random effects regression and a pooled OLS regression.
# The null hypothesis in the LM test is that variances across entities is zero. This is, no
# significant difference across units (i.e. no panel effect)
plmtest(pool, type="bp")
```
```{r}
fe <- plm(fatalities_occ ~ age + belt_usage + violent_crime + unemployment + income +pct_black+pct_hispanic, 
          data = data, model = "within", effect = "twoway")
summary(fe)

# Tests of poolability
# Ho: all intercepts are equals
pooltest(pool, fe)
pFtest(fe, pool)

# Hausman test
phtest(fe, re)
```
